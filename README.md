Supaworker is a job queue for Supabase projects.

> **Note:** This is a work in progress and is not yet ready for production use.

### License

[MIT](./LICENSE)

## Usage

Supaworker is a job queue that is backed by your Supabase database.
Jobs are enqueued as rows in a `supaworker_jobs` table where background workers can pick them up and process them.

A worker is a Supaworker client does the following:

1. Dequeues jobs that match the worker's `queue`
2. Processes jobs until there are none left
2. Listens for new jobs using Supabase's Realtime feature

Timeouts, delayed retries, and scale are left to the developer.

### Setup

Create a new migration

```bash
supabase migration new setup_supaworker
```

And add the following SQL from [here](./supabase/migrations/20240407025302_setup_supaworker.sql).

```sql
CREATE TABLE IF NOT EXISTS "public"."supaworker_jobs" (
  "id" bigint NOT NULL,
  "created_at" timestamp with time zone DEFAULT "now"() NOT NULL,
  "queue" "text" NOT NULL,
  "enabled" boolean DEFAULT true NOT NULL,
  "attempts" smallint DEFAULT '0'::smallint NOT NULL,
  "options" "jsonb",
  "payload" "jsonb"
);
ALTER TABLE "public"."supaworker_jobs" OWNER TO "postgres";
CREATE OR REPLACE FUNCTION "public"."dequeue"("queue_name" character varying) RETURNS SETOF "public"."supaworker_jobs" LANGUAGE "plpgsql" AS $$ #variable_conflict use_variable
  begin return query
delete from "supaworker_jobs"
where id = (
    select id
    from "supaworker_jobs"
    where enabled = true
      and queue = queue_name
    order by created_at asc for
    update skip locked
    limit 1
  )
returning *;
end;
$$;
ALTER FUNCTION "public"."dequeue"("queue_name" character varying) OWNER TO "postgres";
ALTER TABLE "public"."supaworker_jobs"
ALTER COLUMN "id"
ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME "public"."supaworker_jobs_id_seq" START WITH 1 INCREMENT BY 1 NO MINVALUE NO MAXVALUE CACHE 1
  );
CREATE TABLE IF NOT EXISTS "public"."supaworker_logs" (
  "id" "uuid" DEFAULT "gen_random_uuid"() NOT NULL,
  "created_at" timestamp with time zone DEFAULT "now"() NOT NULL,
  "job" "jsonb" NOT NULL,
  "status" character varying NOT NULL
);
ALTER TABLE "public"."supaworker_logs" OWNER TO "postgres";
ALTER TABLE ONLY "public"."supaworker_jobs"
ADD CONSTRAINT "supaworker_jobs_pkey" PRIMARY KEY ("id");
ALTER TABLE ONLY "public"."supaworker_logs"
ADD CONSTRAINT "supaworker_logs_pkey" PRIMARY KEY ("id");
ALTER TABLE "public"."supaworker_jobs" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "public"."supaworker_logs" ENABLE ROW LEVEL SECURITY;
```


Then run the migration:

```bash
supabase migration up --local
```

From Supabase studio, head to Database -> Replication. In the row named "supabase_realtime", click the "_x_ table(s)" button under the "Source" column and toggle the "supaworker_jobs" table to enabled.

### Installation

Add Supaworker to your project:

```bash
npm install --save @typov/supaworker-js
```
